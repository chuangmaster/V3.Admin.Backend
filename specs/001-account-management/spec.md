# Feature Specification: 帳號管理系統

**Feature Branch**: `001-account-management`  
**Created**: 2025-10-26  
**Status**: Draft  
**Input**: User description: "提供帳號密碼登入的功能，帳號資料僅包含帳號、密碼、姓名。新增帳號、刪除帳號、修改個人資料，允許更改密碼、姓名"
**Language**: Traditional Chinese (zh-TW)

## Clarifications

### Session 2025-10-26

- Q: 連續登入失敗處理策略 → A: 不實施鎖定機制,僅記錄失敗嘗試
- Q: 密碼複雜度要求 → A: 僅要求最小 8 字元
- Q: 多裝置同時登入處理 → A: 允許多裝置同時登入,每個會話獨立管理
- Q: 帳號名稱格式限制 → A: 僅允許英數字和底線,3-20 字元
- Q: 刪除帳號時關聯資料處理 → A: 軟刪除：標記為已刪除但保留資料
- Q: 密碼特殊字元處理 → A: 允許所有 Unicode 字元（包含表情符號、中文等）
- Q: 最後一個有效帳號的刪除限制 → A: 不允許,必須至少保留一個有效帳號（權限機制列入下一次需求）
- Q: 新舊密碼相同性限制 → A: 不允許,新密碼必須不同於舊密碼

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 帳號密碼登入 (Priority: P1)

系統管理員需要使用帳號和密碼登入系統以進行後續的帳號管理操作。

**為何是此優先順序**：登入功能是系統的基礎，沒有登入功能就無法進行任何其他操作，因此是最高優先級。

**獨立測試**：可以透過建立測試帳號，然後使用正確/錯誤的帳號密碼組合進行登入測試，驗證系統能否正確識別有效的登入憑證。

**驗收場景**：

1. **Given** 系統中存在一個有效的帳號（帳號：admin，密碼：password123，姓名：管理員），**When** 使用者輸入正確的帳號和密碼，**Then** 系統允許使用者登入並顯示歡迎訊息
2. **Given** 系統中存在一個有效的帳號，**When** 使用者輸入正確的帳號但錯誤的密碼，**Then** 系統拒絕登入並顯示「帳號或密碼錯誤」的訊息
3. **Given** 使用者尚未登入，**When** 使用者輸入不存在的帳號，**Then** 系統拒絕登入並顯示「帳號或密碼錯誤」的訊息
4. **Given** 使用者已成功登入，**When** 使用者重新整理頁面或關閉後重新開啟，**Then** 系統保持登入狀態直到使用者登出或會話逾時

---

### User Story 2 - 新增帳號 (Priority: P2)

系統管理員需要能夠建立新的帳號，提供帳號、密碼和姓名資訊。

**為何是此優先順序**：新增帳號是帳號管理的核心功能，僅次於登入功能，讓系統能夠擴展使用者基礎。

**獨立測試**：登入系統後，可以透過新增帳號介面輸入新的帳號資訊，驗證系統能否成功建立帳號並允許該新帳號登入。

**驗收場景**：

1. **Given** 系統管理員已登入，**When** 管理員輸入唯一的帳號、有效的密碼和姓名，**Then** 系統成功建立新帳號並顯示成功訊息
2. **Given** 系統管理員已登入，**When** 管理員嘗試建立一個已存在的帳號，**Then** 系統拒絕建立並顯示「帳號已存在」的錯誤訊息
3. **Given** 系統管理員已登入，**When** 管理員輸入空白的帳號、密碼或姓名，**Then** 系統拒絕建立並顯示相應的必填欄位錯誤訊息
4. **Given** 新帳號已成功建立，**When** 使用新帳號和密碼進行登入，**Then** 系統允許使用新帳號登入

---

### User Story 3 - 修改個人資料 (Priority: P2)

使用者需要能夠修改自己的密碼和姓名。

**為何是此優先順序**：允許使用者更新自己的資訊是基本的帳號維護功能，與新增帳號同等重要。

**獨立測試**：使用現有帳號登入後，可以透過修改個人資料介面更改密碼或姓名，然後驗證變更是否生效（例如使用新密碼登入或檢查姓名是否更新）。

**驗收場景**：

1. **Given** 使用者已登入，**When** 使用者輸入舊密碼和新密碼，**Then** 系統更新密碼並顯示成功訊息
2. **Given** 使用者已更新密碼，**When** 使用者登出後使用新密碼登入，**Then** 系統允許使用新密碼登入
3. **Given** 使用者已登入，**When** 使用者修改姓名，**Then** 系統更新姓名並在介面上顯示新的姓名
4. **Given** 使用者已登入，**When** 使用者嘗試更改密碼但輸入錯誤的舊密碼，**Then** 系統拒絕更新並顯示「舊密碼錯誤」的訊息
5. **Given** 使用者已登入，**When** 使用者嘗試將姓名改為空白，**Then** 系統拒絕更新並顯示「姓名不可為空」的錯誤訊息
6. **Given** 使用者已登入，**When** 使用者嘗試將新密碼設定為與舊密碼相同，**Then** 系統拒絕更新並顯示「新密碼不可與舊密碼相同」的錯誤訊息

---

### User Story 4 - 刪除帳號 (Priority: P3)

系統管理員需要能夠刪除不再需要的帳號。

**為何是此優先順序**：刪除帳號是管理功能，雖然重要但不如建立和修改帳號緊急，因為系統可以先運作而暫時不刪除舊帳號。

**獨立測試**：登入系統後，可以選擇一個現有帳號進行刪除，然後驗證該帳號無法再登入系統。

**驗收場景**：

1. **Given** 系統管理員已登入且系統中存在多個帳號，**When** 管理員選擇一個帳號並執行刪除操作，**Then** 系統成功刪除該帳號並顯示成功訊息
2. **Given** 帳號已被刪除，**When** 嘗試使用被刪除的帳號登入，**Then** 系統拒絕登入並顯示「帳號或密碼錯誤」的訊息
3. **Given** 系統管理員已登入，**When** 管理員嘗試刪除自己正在使用的帳號，**Then** 系統拒絕刪除並顯示「無法刪除當前登入的帳號」的警告訊息
4. **Given** 系統管理員準備刪除帳號，**When** 管理員點擊刪除按鈕，**Then** 系統顯示確認對話框要求二次確認

---

### Edge Cases

- 系統允許使用者在多個裝置或瀏覽器同時登入，每個會話獨立管理且互不影響
- 當使用者連續輸入錯誤密碼多次時,系統不會鎖定帳號,但會記錄所有失敗嘗試(包含帳號名稱、時間、IP、失敗原因)到日誌系統供審計與安全分析使用
- 密碼允許包含所有 Unicode 字元（包含特殊字元、非 ASCII 字元、中文、表情符號等），系統以 UTF-8 編碼處理
- 帳號名稱僅允許英數字（a-z, A-Z, 0-9）和底線（_）,長度限制為 3-20 字元,不允許空格或其他特殊字元
- 刪除帳號時採用軟刪除機制,標記為已刪除狀態但保留所有資料和關聯記錄,以維持審計追蹤完整性
- 系統不允許刪除最後一個有效（未刪除）帳號,必須至少保留一個有效帳號以防止系統無法存取
- 修改密碼時,新密碼不可與舊密碼相同,系統會驗證並拒絕相同的新密碼

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系統必須提供帳號密碼登入功能，使用者輸入帳號和密碼後進行身份驗證
- **FR-002**: 系統必須在登入成功後建立和維護使用者會話,使用 JWT Token 機制,Token 有效期為 1 小時。會話管理需支援:
  - Token 到期後自動失效,使用者需重新登入
  - 允許同一帳號在多個裝置或瀏覽器同時登入,每個會話(Token)獨立管理且互不干擾
  - 前端應用負責管理 Token 儲存與清除
- **FR-003**: 系統必須提供新增帳號功能，允許管理員建立包含帳號、密碼和姓名的新使用者
- **FR-004**: 系統必須驗證帳號的唯一性，不允許建立重複的帳號
- **FR-004-1**: 系統必須驗證帳號名稱格式，僅允許英數字（a-z, A-Z, 0-9）和底線（_），長度必須為 3-20 字元
- **FR-005**: 系統必須執行以下欄位驗證:
  - 所有必填欄位(帳號、密碼、姓名)不可為空
  - 密碼長度至少為 8 個字元,不限制字元類型或複雜度
  - 密碼支援所有 Unicode 字元(包含特殊字元、非 ASCII 字元、中文、表情符號等),並以 UTF-8 編碼正確處理和儲存
- **FR-006**: 系統必須提供修改個人資料功能，允許使用者更改自己的密碼和姓名
- **FR-007**: 系統必須在使用者更改密碼時驗證舊密碼的正確性
- **FR-007-1**: 系統必須驗證新密碼不可與舊密碼相同,若相同則拒絕更新並顯示錯誤訊息
- **FR-008**: 系統必須提供刪除帳號功能,允許管理員移除不需要的帳號
- **FR-008-1**: 系統必須使用軟刪除機制,將帳號標記為已刪除狀態而非實際移除資料,以保留審計追蹤和關聯記錄
- **FR-008-2**: 系統必須防止已標記為刪除的帳號登入系統
- **FR-008-3**: 系統必須防止刪除最後一個有效（未刪除）帳號,以確保系統至少有一個可用的管理員帳號
- **FR-009**: 系統必須防止使用者刪除自己當前登入的帳號
- **FR-010**: 系統必須在刪除帳號前要求二次確認,防止誤刪
- **FR-011**: 系統必須在登入失敗時顯示通用的錯誤訊息（「帳號或密碼錯誤」），避免洩露帳號是否存在的資訊
- **FR-012**: 系統必須安全地儲存密碼（使用雜湊演算法而非明文儲存）
- **FR-013**: 系統的登出機制採用前端處理:前端應用刪除儲存的 JWT Token。由於 JWT 為無狀態設計,後端不需要維護登出端點或 Token 黑名單(Token 過期後自動失效)。使用者登出即為前端清除 Token 並導向登入頁面
- **FR-014**: 系統必須記錄所有登入失敗嘗試供審計使用,但不實施帳號鎖定機制。記錄內容包含:
  - 嘗試登入的帳號名稱(即使帳號不存在也記錄)
  - 失敗時間戳記(UTC)
  - 來源 IP 位址(從 HTTP Request Headers 取得)
  - 失敗原因(帳號不存在、密碼錯誤、帳號已刪除等)
  記錄方式可使用結構化日誌(如 Serilog)或資料庫表格,由實作階段決定

### Key Entities

- **帳號 (Account)**: 代表系統中的使用者,包含以下關鍵屬性：
  - 帳號名稱：唯一識別碼,用於登入（3-20 字元,僅限英數字和底線）
  - 密碼：用於身份驗證的憑證（以安全方式儲存,最小 8 字元）
  - 姓名：使用者的顯示名稱
  - 建立時間：帳號建立的時間戳記
  - 最後修改時間：帳號資料最後更新的時間戳記
  - 刪除狀態：標記帳號是否已被軟刪除（布林值或刪除時間戳記）

## Success Criteria *(mandatory)*

### Out of Scope

以下功能明確不包含在本次需求中,將列入未來的功能開發：

- **權限管理系統**: 使用者角色、權限分級、特殊管理員權限等機制將在下一次需求中設計和實作
- **審計日誌查詢**: 虽然系統會記錄登入失敗嘗試,但查詢和分析這些日誌的功能不包含在本次範圍內

### Measurable Outcomes

- **SC-001**: 使用者能夠在 5 秒內完成登入流程(測量範圍:從前端送出登入請求到收到 JWT Token 並導向主頁面,包含網路傳輸時間)
- **SC-002**: 系統能夠在 2 秒內完成帳號的新增、修改或刪除操作(測量範圍:從 API 請求到達後端到回傳完整回應,不含前端渲染時間)
- **SC-003**: 95% 的使用者能夠在第一次嘗試時成功登入（使用正確憑證時）
- **SC-004**: 帳號管理操作的錯誤率低於 1%（排除使用者輸入錯誤）
- **SC-005**: 系統能夠同時支援至少 100 個並發登入請求而不影響效能
- **SC-006**: 密碼更改後，使用者能夠立即使用新密碼登入（不超過 1 秒的延遲）
- **SC-007**: 所有帳號管理操作都有清晰的成功或失敗回饋，使用者無需猜測操作結果

## Assumptions

- 系統假設使用 JWT Token 進行會話管理,Token 有效期為 1 小時(業界標準做法)
- 系統假設登出由前端處理(刪除 Token),後端不維護 Token 黑名單(JWT 無狀態設計)
- 系統假設使用標準的密碼雜湊演算法（如 bcrypt 或 Argon2）進行密碼儲存
- 系統假設帳號名稱不區分大小寫，以避免混淆（例如：Admin 和 admin 視為相同帳號）
- 系統假設帳號名稱僅允許英數字和底線，長度限制為 3-20 字元
- 系統假設密碼最小長度為 8 個字元，不強制要求複雜度（如大小寫、數字、特殊字元組合）
- 系統假設密碼支援所有 Unicode 字元，以 UTF-8 編碼處理，字元長度以 Unicode 字元數計算而非位元組數
- 系統假設每個使用者只能修改自己的個人資料,除非是管理員帳號
- 系統假設至少需要保留一個有效（未刪除）帳號,以防止系統無法存取
- 系統假設刪除帳號使用軟刪除機制,資料保留以維持審計追蹤,被刪除的帳號無法登入但資料仍然存在
