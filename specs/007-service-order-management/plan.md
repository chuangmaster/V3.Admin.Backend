# Implementation Plan: 服務單管理模組

**Branch**: `007-service-order-management` | **Date**: 2025-12-16 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/007-service-order-management/spec.md`

**Note**: This template is filled in by the `/speckit.plan` command. See `.specify/templates/commands/plan.md` for the execution workflow.

## Summary

本功能實作服務單管理模組,支援店員建立、查詢、修改寄賣單與收購單。核心功能包含:客戶資料管理(搜尋既有客戶或新增客戶)、身分證明文件上傳與 AI OCR 辨識(Azure Vision + Google Gemini)、線下/線上簽名流程(SignaturePad/Dropbox Sign)、商品項目管理(1-4件商品,支援配件與瑕疵記錄)、服務單查詢與修改歷史追蹤、並發控制(樂觀鎖)、附件管理(Azure Blob Storage + SAS Token)。系統使用三層架構,Dapper ORM,PostgreSQL 資料庫,採用 JWT 認證與 FluentValidation 驗證,確保資料安全與操作可稽核性。

## Technical Context

**Language/Version**: C# 13 / .NET 10.0  
**Primary Framework**: ASP.NET Core 10.0 (Web API)  
**Database**: PostgreSQL 15+ (本地開發環境)  
**ORM**: Dapper (Micro-ORM)  
**Authentication**: JWT Bearer Token (Microsoft.AspNetCore.Authentication.JwtBearer)  
**Input Validation**: FluentValidation  
**API Documentation**: Swagger/OpenAPI 3.0 (Swashbuckle.AspNetCore)  
**Logging**: Serilog / Microsoft.Extensions.Logging  
**Testing**: xUnit, Moq, FluentAssertions, Testcontainers  
**Target Platform**: Linux/Windows Server (Dockerized)  
**Project Type**: ASP.NET Core Web API (Single Project Architecture)  
**Architecture Pattern**: Three-layer architecture (Controller → Service → Repository)

**Feature-Specific Technologies**:
- **檔案儲存**: Azure Blob Storage + SAS Token (安全存取機制)
- **OCR 服務**: Azure Vision (文字擷取) + Google Gemini (結構化解析與驗證)
- **PDF 處理**: PDFsharp (簽名合併與預覽)
- **線上簽名**: Dropbox Sign API (線上簽名邀請與狀態追蹤)
- **序列號生成**: PostgreSQL Sequence (每日重置流水號,確保並發安全)
- **線下簽名**: SignaturePad 或類似 JavaScript 函式庫 (前端觸控簽名,產生 Base64 PNG)

**Performance Goals**: 
- API response time < 200ms (p95)
- 身分證 OCR 辨識時間 < 3s
- 檔案上傳限制 10MB,單次請求處理時間 < 5s
- 支援 100 位店員同時建立服務單
- Database query optimization (proper indexing, avoid N+1 queries)

**Constraints**: 
- All API responses must use unified format (ApiResponseModel<T>)
- All exceptions must be handled by ExceptionHandlingMiddleware
- All requests must include TraceId (generated by TraceIdMiddleware)
- 敏感資料(客戶身分證字號、身分證照片查看記錄)必須記錄於 audit logs
- 身分證明文件存取必須產生查看日誌(個資稽核)
- Database fields use snake_case, C# properties use PascalCase
- 所有刪除操作採用軟刪除(is_deleted 標記)
- 並發更新使用樂觀鎖(version 欄位)

**Scale/Scope**: 
- Expected users: 100-200 位店員
- Data volume: 預估每日 50-100 筆服務單,年度累積 2-4 萬筆
- API endpoints: 新增約 15-20 個端點(服務單 CRUD、客戶管理、附件管理、簽名管理)

**Key Technical Decisions Requiring Research**:
1. **Azure Vision + Google Gemini OCR 整合模式**: 如何串接兩個服務?錯誤處理與降級策略?信心度評分如何綜合?
2. **PDFsharp 繁體中文支援**: 如何確保繁體中文字體正確渲染?簽名圖片如何定位到 PDF 指定位置?
3. **Dropbox Sign API Webhook 驗證機制**: API Key 驗證如何實作?Webhook 端點如何防止重放攻擊?
4. **PostgreSQL Sequence 每日重置策略**: 如何設計 Sequence 達成每日從 001 重置?是否需要額外的觸發器或排程任務?
5. **Azure Blob Storage SAS Token 管理**: SAS Token 生成策略?有效期設定?如何確保安全性與可用性?
6. **商品項目與服務單的資料庫設計**: 1-N 關係如何建模?寄賣單/收購單共用商品表還是分開?
7. **修改歷史記錄機制**: 如何追蹤欄位變更(舊值/新值)?使用 EF Core Change Tracking 還是手動實作?
8. **簽名記錄資料模型**: 線下簽名(Base64 PNG)與線上簽名(Dropbox Sign Request ID)如何統一建模?

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

Verify whether this feature complies with the five core principles of the [Project Constitution](../../.specify/memory/constitution.md):

### ✅ Principle 1: Simplicity First
- [x] Adopt three-layer architecture (Controller → Service → Repository)
- [x] Avoid unnecessary abstraction layers or design patterns
- [x] Prioritize using .NET built-in features
- [x] Document clear reasons if introducing new patterns
  - **評估**: 使用標準三層架構,新增的 PDFsharp、Azure SDK、Dropbox Sign SDK 皆為必要依賴,無額外抽象層

### ✅ Principle 2: Test-Driven Quality
- [x] Critical paths have unit test coverage
  - 服務單建立、客戶搜尋、OCR 辨識、簽名流程、並發控制
- [x] API endpoints have integration tests (using Testcontainers)
  - 所有服務單 CRUD 端點、客戶管理端點、附件管理端點
- [x] Tests written before implementation (TDD)
- [x] Validators achieve 100% test coverage
  - CreateServiceOrderRequestValidator、UpdateServiceOrderRequestValidator、CreateCustomerRequestValidator

### ✅ Principle 3: Security Non-Negotiable
- [x] API endpoints use JWT Bearer Token authentication (except login)
- [x] Passwords use BCrypt hashing (work factor 12) - N/A (本功能不涉及密碼)
- [x] Database queries use parameterized queries (Dapper parameters)
- [x] Input validation uses FluentValidation
  - 所有 Request 模型均有對應 Validator
- [x] Delete operations use soft delete
  - 服務單、客戶、附件均採軟刪除
- [x] Concurrent updates use optimistic locking (version field)
  - 服務單修改使用 version 欄位樂觀鎖
- [x] Sensitive settings use environment variables or Azure Key Vault
  - Azure Blob Storage 連接字串、Dropbox Sign API Key、Google Gemini API Key 使用環境變數
- [x] Additional security measures:
  - 身分證明文件查看記錄(個資稽核)
  - Dropbox Sign Webhook API Key 驗證
  - Azure Blob Storage SAS Token 時效性控制(1 小時)

### ✅ Principle 4: Observability First
- [x] HTTP requests include TraceId
- [x] Exceptions log full stack traces
- [x] Critical operations write to audit logs (audit_logs table)
  - 服務單建立、修改、狀態變更、敏感附件查看
- [x] Use structured logging (Serilog / ILogger)
- [x] API responses include unified format (ApiResponseModel<T>)
- [x] Additional observability:
  - OCR 辨識信心度記錄
  - Dropbox Sign API 呼叫失敗日誌
  - 並發衝突偵測日誌

### ✅ Principle 5: Documentation as Code
- [x] Public APIs have XML documentation comments
- [x] Features have complete documentation (spec.md, plan.md, quickstart.md)
- [x] User stories have priority sorting (P1, P2, P3...)
  - P1: 線下收購單建立、線下寄賣單建立
  - P2: 客戶搜尋與管理、服務單查詢與管理
  - P3: 線上服務單建立
- [x] API contract documentation synchronized (api-spec.yaml)
- [x] All user-facing documentation in Traditional Chinese
- [x] Code comments in Traditional Chinese

**Constitution Check Result**: PASS

**Conditional or Violation Explanation**: 
- 無違反憲章原則之處
- 新增依賴(PDFsharp、Azure SDK、Dropbox Sign SDK)均為核心功能所需,無更簡單替代方案
- 遵循簡單性原則:未引入額外抽象層,直接使用 SDK 原生 API

## Project Structure

### Documentation (this feature)

```text
specs/[###-feature]/
├── plan.md              # This file (/speckit.plan command output)
├── research.md          # Phase 0 output (/speckit.plan command)
├── data-model.md        # Phase 1 output (/speckit.plan command)
├── quickstart.md        # Phase 1 output (/speckit.plan command)
├── contracts/           # Phase 1 output (/speckit.plan command)
└── tasks.md             # Phase 2 output (/speckit.tasks command - NOT created by /speckit.plan)
```

### Source Code (V3.Admin.Backend Project Structure)

**Project Type**: ASP.NET Core Web API (Single Project Architecture)

```text
V3.Admin.Backend/                    # Project root directory
├── Controllers/                     # API controllers (Presentation layer)
│   ├── AuthController.cs           # Authentication endpoints
│   ├── AccountController.cs        # Account management endpoints
│   ├── PermissionController.cs     # Permission management endpoints
│   ├── RoleController.cs           # Role management endpoints
│   ├── UserRoleController.cs       # User role endpoints
│   ├── AuditLogController.cs       # Audit log endpoints
│   └── BaseApiController.cs        # Base controller
│
├── Services/                        # Business logic layer
│   ├── Interfaces/                 # Service interfaces
│   │   ├── IAuthService.cs
│   │   ├── IAccountService.cs
│   │   ├── IPermissionService.cs
│   │   └── ...
│   ├── AuthService.cs
│   ├── AccountService.cs
│   ├── PermissionService.cs
│   ├── JwtService.cs
│   └── ...
│
├── Repositories/                    # Data access layer
│   ├── Interfaces/                 # Repository interfaces
│   │   ├── IUserRepository.cs
│   │   ├── IPermissionRepository.cs
│   │   └── ...
│   ├── UserRepository.cs
│   ├── PermissionRepository.cs
│   ├── RoleRepository.cs
│   └── ...
│
├── Models/                          # Data models
│   ├── Entities/                   # Database entities (snake_case mapping)
│   │   ├── User.cs
│   │   ├── Permission.cs
│   │   └── ...
│   ├── Dtos/                       # Data transfer objects
│   │   ├── UserDto.cs
│   │   ├── PermissionDto.cs
│   │   └── ...
│   ├── Requests/                   # API request models
│   │   ├── LoginRequest.cs
│   │   ├── CreateAccountRequest.cs
│   │   └── ...
│   ├── Responses/                  # API response models
│   │   ├── LoginResponse.cs
│   │   ├── AccountResponse.cs
│   │   └── ...
│   ├── ApiResponseModel.cs         # Unified response wrapper
│   └── ResponseCodes.cs            # Response code definitions
│
├── Validators/                      # FluentValidation validators
│   ├── LoginRequestValidator.cs
│   ├── CreateAccountRequestValidator.cs
│   └── ...
│
├── Middleware/                      # ASP.NET Core middleware
│   ├── ExceptionHandlingMiddleware.cs
│   ├── TraceIdMiddleware.cs
│   └── PermissionAuthorizationMiddleware.cs
│
├── Configuration/                   # Configuration models
│   ├── DatabaseSettings.cs
│   ├── JwtSettings.cs
│   └── ...
│
├── Database/                        # Database scripts
│   ├── Migrations/                 # Migration scripts (executed in order)
│   │   ├── 001_CreateUsersTable.sql
│   │   ├── 002_CreatePermissionsTable.sql
│   │   └── ...
│   └── Scripts/                    # Seed data and helper scripts
│       └── seed.sql
│
├── Tests/                           # Test project
│   ├── Unit/                       # Unit tests
│   │   ├── Validators/             # Validator tests
│   │   └── Services/               # Service tests
│   ├── Integration/                # Integration tests (using Testcontainers)
│   │   └── Controllers/            # API endpoint tests
│   └── Helpers/                    # Test helper utilities
│
├── specs/                           # Feature specification documents (Traditional Chinese)
│   └── [###-feature-name]/
│       ├── spec.md
│       ├── plan.md
│       ├── quickstart.md
│       ├── data-model.md
│       ├── tasks.md
│       └── contracts/
│           └── api-spec.yaml
│
├── .specify/                        # Speckit configuration
│   ├── memory/
│   │   ├── constitution.md         # Project constitution
│   │   └── technical-reference.md  # Technical reference
│   └── templates/
│
├── Program.cs                       # Application entry point
├── appsettings.json                # Application settings
├── appsettings.Development.json    # Development environment settings
├── Dockerfile                       # Docker containerization
└── V3.Admin.Backend.csproj         # Project file
```

**Architecture Notes**:
- **Three-layer architecture**: Controller → Service → Repository
- **DTO pattern**: API and business logic layers use DTOs, data layer uses Entities
- **Interface segregation**: Services and Repositories both have corresponding Interfaces folders
- **Dependency injection**: All services and Repositories registered in Program.cs

## Complexity Tracking

> **Fill ONLY if Constitution Check has violations that must be justified**

| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|-------------------------------------|
| [e.g., 4th project] | [current need] | [why 3 projects insufficient] |
| [e.g., Repository pattern] | [specific problem] | [why direct DB access insufficient] |
