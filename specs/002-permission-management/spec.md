# Feature Specification: 權限管理機制

**Feature Branch**: `002-permission-management`  
**Created**: 2025-11-05  
**Status**: Draft  
**Input**: 作為一個權限管理機制必須包含以下幾個重點：1. 權限管理機制必須包含畫面的路由權限、功能權限，能夠新增刪除查詢該權限機制；2. 角色，作為指派權限的管理機制，必須要能自訂角色，角色可以分別指派路由的權限、功能權限；3. AuditLog要求記錄操作者、時間、變更前後狀態、IP、UserAgent等欄位以支援稽核  
**Language**: Traditional Chinese (zh-TW)

## Clarifications

### Session 2025-11-05

- Q: 稽核日誌應該保留多久？ → A: 永久保留（合規要求）
- Q: 當用戶多次權限驗證失敗時，系統應該如何處理？ → A: 僅記錄失敗嘗試
- Q: 當管理員修改角色的權限配置後，變更應該何時對已登入用戶生效？ → A: 即時生效（下次請求）

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 權限建立與管理 (Priority: P1)

系統管理員需要定義系統中所有可用的權限，包括路由權限（頁面訪問權限）和功能權限（操作權限如新增、修改、刪除）。管理員可以新增、修改、刪除和查詢所有權限。

**Why this priority**: 權限是整個權限管理機制的基礎，沒有權限定義就無法進行角色配置和用戶授權。這是系統最核心的功能。

**Independent Test**: 管理員可以登入系統後，在權限管理頁面創建一個路由權限（如「庫存管理頁面」）和相關的功能權限（如「新增庫存」、「修改庫存」、「刪除庫存」），並能查詢、修改或刪除這些權限，而無需其他功能即可驗證。

**Acceptance Scenarios**:

1. **Given** 管理員已登入系統，**When** 管理員在權限管理頁面新增一個路由權限「/inventory」名稱為「庫存管理頁面」，**Then** 系統成功創建該權限並顯示在權限列表中
2. **Given** 管理員已登入系統，**When** 管理員在權限管理頁面新增一個功能權限「inventory.create」名稱為「新增庫存」，**Then** 系統成功創建該功能權限並顯示在權限列表中
3. **Given** 權限列表中已存在多個權限，**When** 管理員使用搜尋功能查詢「庫存」相關權限，**Then** 系統僅顯示名稱或代碼包含「庫存」的權限
4. **Given** 管理員選擇一個已存在的權限，**When** 管理員修改該權限的名稱或描述後儲存，**Then** 系統更新該權限並在列表中顯示更新後的資訊
5. **Given** 管理員選擇一個未被任何角色使用的權限，**When** 管理員執行刪除操作，**Then** 系統成功刪除該權限並從列表中移除
6. **Given** 管理員選擇一個已被角色使用的權限，**When** 管理員嘗試刪除該權限，**Then** 系統顯示錯誤訊息「該權限正被角色使用，無法刪除」

---

### User Story 2 - 角色建立與權限配置 (Priority: P1)

系統管理員需要創建自訂角色，並為每個角色配置適當的路由權限和功能權限。角色是權限集合的載體，用於簡化用戶的權限管理。

**Why this priority**: 角色是連接權限和用戶的關鍵橋樑，必須在權限定義後立即可用，才能進行用戶授權。這是第二優先的核心功能。

**Independent Test**: 管理員可以創建一個「庫存管理員」角色，為其分配「庫存管理頁面」路由權限以及「新增庫存」、「修改庫存」、「查詢庫存」功能權限，並能查詢、修改或刪除角色，無需實際指派給用戶即可驗證功能。

**Acceptance Scenarios**:

1. **Given** 管理員已登入系統且系統中已定義多個權限，**When** 管理員新增一個角色「庫存管理員」，**Then** 系統成功創建該角色並顯示在角色列表中
2. **Given** 管理員正在編輯「庫存管理員」角色，**When** 管理員從可用權限列表中選擇路由權限「庫存管理頁面」和功能權限「新增庫存」、「修改庫存」後儲存，**Then** 系統將這些權限關聯到該角色
3. **Given** 角色列表中已存在多個角色，**When** 管理員查詢特定角色，**Then** 系統顯示該角色的詳細資訊，包括所有已分配的路由權限和功能權限
4. **Given** 管理員正在編輯某個角色的權限，**When** 管理員移除某個已分配的權限後儲存，**Then** 系統解除該權限與角色的關聯
5. **Given** 管理員選擇一個未被任何用戶使用的角色，**When** 管理員執行刪除操作，**Then** 系統成功刪除該角色
6. **Given** 管理員選擇一個已被用戶使用的角色，**When** 管理員嘗試刪除該角色，**Then** 系統顯示錯誤訊息「該角色正被用戶使用，無法刪除」

---

### User Story 3 - 用戶角色指派 (Priority: P2)

系統管理員需要為用戶指派一個或多個角色，使用戶繼承角色所擁有的所有權限。管理員可以隨時調整用戶的角色分配。

**Why this priority**: 用戶角色指派是權限機制發揮作用的關鍵步驟，但需要在權限和角色建立完成後才有意義。屬於次要但必要的功能。

**Independent Test**: 管理員可以選擇一個已存在的用戶，為其指派「庫存管理員」角色，系統記錄該指派關係，管理員可以查詢該用戶當前擁有的角色，並可以移除角色分配。

**Acceptance Scenarios**:

1. **Given** 管理員已登入系統且系統中已存在用戶和角色，**When** 管理員為用戶「張三」指派「庫存管理員」角色，**Then** 系統成功建立用戶與角色的關聯
2. **Given** 用戶「張三」已被指派「庫存管理員」角色，**When** 管理員查詢該用戶的角色資訊，**Then** 系統顯示該用戶擁有的所有角色及其權限清單
3. **Given** 用戶「張三」已被指派多個角色，**When** 管理員移除其中一個角色後儲存，**Then** 系統解除該角色與用戶的關聯，但保留其他角色
4. **Given** 用戶「張三」擁有「庫存管理員」角色，**When** 該用戶嘗試訪問「/inventory」頁面，**Then** 系統允許訪問該頁面
5. **Given** 用戶「張三」擁有「庫存管理員」角色但該角色不包含「刪除庫存」權限，**When** 該用戶嘗試執行刪除庫存操作，**Then** 系統拒絕該操作並顯示「權限不足」訊息

---

### User Story 4 - 權限驗證與訪問控制 (Priority: P1)

系統必須在用戶訪問頁面或執行操作時，即時驗證用戶是否擁有相應的路由權限或功能權限，並根據驗證結果允許或拒絕訪問。

**Why this priority**: 權限驗證是權限管理機制的執行層，確保權限配置真正生效。沒有這個功能，前面的權限和角色配置將毫無意義。這是核心必要功能。

**Independent Test**: 創建一個測試用戶並指派特定權限，測試該用戶訪問不同頁面和執行不同操作時，系統是否正確允許或拒絕，可以通過自動化測試或手動測試獨立驗證。

**Acceptance Scenarios**:

1. **Given** 用戶「李四」登入系統且擁有「/dashboard」路由權限，**When** 該用戶嘗試訪問「/dashboard」頁面，**Then** 系統允許訪問並顯示頁面內容
2. **Given** 用戶「李四」登入系統但不擁有「/inventory」路由權限，**When** 該用戶嘗試訪問「/inventory」頁面，**Then** 系統拒絕訪問並顯示「無權限訪問此頁面」錯誤訊息
3. **Given** 用戶「李四」在「/inventory」頁面且擁有「inventory.view」功能權限，**When** 該用戶嘗試查詢庫存資料，**Then** 系統執行查詢並返回結果
4. **Given** 用戶「李四」在「/inventory」頁面但不擁有「inventory.create」功能權限，**When** 該用戶嘗試執行新增庫存操作，**Then** 系統拒絕該操作並顯示「權限不足，無法執行此操作」錯誤訊息
5. **Given** 用戶「李四」擁有多個角色且這些角色有重疊的權限，**When** 系統驗證該用戶的權限時，**Then** 系統合併所有角色的權限並允許用戶執行任何一個角色允許的操作
6. **Given** 用戶「李四」的角色權限在其登入期間被修改，**When** 該用戶嘗試執行操作時，**Then** 系統使用最新的權限配置進行驗證

---

### User Story 5 - 稽核日誌記錄 (Priority: P2)

系統必須記錄所有與權限管理相關的操作，包括權限的新增、修改、刪除，角色的創建、權限分配，用戶角色的指派等。每條日誌記錄必須包含操作者、操作時間、變更前後狀態、操作者IP位址、操作者UserAgent等資訊。

**Why this priority**: 稽核日誌是確保系統安全性和可追溯性的重要功能，對於合規性和問題排查至關重要。但不影響權限機制的基本運作，屬於增強性功能。

**Independent Test**: 執行一系列權限管理操作（如創建權限、分配角色），然後查詢稽核日誌，驗證所有操作是否被正確記錄，包含所有必要的欄位資訊。

**Acceptance Scenarios**:

1. **Given** 管理員「王五」新增一個權限「product.create」，**When** 操作完成後，**Then** 系統在稽核日誌中記錄：操作者「王五」、操作時間、操作類型「新增權限」、變更前狀態「無」、變更後狀態「權限詳細資訊」、IP位址、UserAgent
2. **Given** 管理員「王五」修改角色「庫存管理員」的權限配置，**When** 操作完成後，**Then** 系統在稽核日誌中記錄：操作者「王五」、操作時間、操作類型「修改角色權限」、變更前狀態「原權限列表」、變更後狀態「新權限列表」、IP位址、UserAgent
3. **Given** 管理員「王五」為用戶「張三」指派角色，**When** 操作完成後，**Then** 系統在稽核日誌中記錄：操作者「王五」、操作時間、操作類型「指派角色」、目標用戶「張三」、變更前狀態「原角色列表」、變更後狀態「新角色列表」、IP位址、UserAgent
4. **Given** 管理員「王五」刪除一個權限，**When** 操作完成後，**Then** 系統在稽核日誌中記錄：操作者「王五」、操作時間、操作類型「刪除權限」、變更前狀態「權限詳細資訊」、變更後狀態「無」、IP位址、UserAgent
5. **Given** 系統中已累積大量稽核日誌，**When** 管理員使用篩選條件（如時間範圍、操作者、操作類型）查詢日誌，**Then** 系統僅返回符合篩選條件的日誌記錄
6. **Given** 管理員查詢某個用戶的操作歷史，**When** 選擇該用戶並指定時間範圍，**Then** 系統顯示該用戶在該時間範圍內的所有操作日誌

---

### User Story 6 - 權限繼承與合併 (Priority: P3)

當用戶被指派多個角色時，系統必須合併所有角色的權限，用戶擁有所有角色的聯集權限。系統應提供介面讓管理員查看用戶的有效權限（合併後的結果）。

**Why this priority**: 這是提升管理員管理效率的輔助功能，幫助管理員快速了解用戶的實際權限狀況。不影響核心功能運作，屬於優化性功能。

**Independent Test**: 創建兩個角色（如「庫存查詢員」和「庫存管理員」），為用戶同時指派這兩個角色，然後查詢該用戶的有效權限，驗證系統是否正確顯示兩個角色的聯集權限。

**Acceptance Scenarios**:

1. **Given** 用戶「趙六」被指派「角色A」和「角色B」，**When** 管理員查詢該用戶的有效權限，**Then** 系統顯示「角色A」和「角色B」所有權限的聯集
2. **Given** 用戶「趙六」的「角色A」包含權限P1、P2，「角色B」包含權限P2、P3，**When** 系統合併權限時，**Then** 用戶擁有P1、P2、P3三個權限（去重）
3. **Given** 管理員正在查看用戶「趙六」的權限詳情頁面，**When** 頁面加載完成，**Then** 系統同時顯示該用戶的角色列表和有效權限列表
4. **Given** 用戶「趙六」被移除其中一個角色，**When** 管理員再次查詢該用戶的有效權限，**Then** 系統顯示更新後的權限列表（移除的角色的獨有權限不再顯示）

---

### Edge Cases

- **當權限被刪除時**：如果某個權限正被一個或多個角色使用，系統應拒絕刪除並提示管理員需要先從角色中移除該權限
- **當角色被刪除時**：如果某個角色正被一個或多個用戶使用，系統應拒絕刪除並提示管理員需要先從用戶中移除該角色
- **當用戶無任何角色時**：用戶登入系統但未被指派任何角色，系統應拒絕該用戶訪問除了個人資料頁面外的所有功能頁面
- **當用戶登入期間角色權限變更時**：用戶已登入且其角色的權限配置在其會話期間被修改，系統應在下次權限驗證時使用最新的權限配置（而非用戶登入時的快照）
- **當系統接收到無效的權限代碼時**：前端傳送不存在的權限代碼進行驗證，系統應返回「權限不存在」錯誤而非允許或拒絕訪問
- **當稽核日誌記錄失敗時**：執行權限管理操作時，如果稽核日誌寫入失敗（如資料庫異常），系統應回滾整個操作並向管理員顯示錯誤訊息
- **當大量用戶同時訪問時**：系統需要處理併發的權限驗證請求，確保權限驗證邏輯的執行緒安全和性能
- **當權限代碼重複時**：管理員嘗試創建一個已存在的權限代碼，系統應拒絕並提示「權限代碼已存在」
- **當角色名稱重複時**：管理員嘗試創建一個已存在的角色名稱，系統應拒絕並提示「角色名稱已存在」
- **當操作者資訊缺失時**：在記錄稽核日誌時，如果無法獲取操作者IP或UserAgent，系統應使用預設值（如「UNKNOWN」）而非失敗
- **當權限驗證失敗記錄查詢時**：管理員應能查詢特定用戶或IP的權限驗證失敗歷史，以識別潛在的安全威脅或誤配置問題

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系統必須提供權限管理介面，允許管理員新增、修改、刪除和查詢權限
- **FR-002**: 系統必須支援兩種類型的權限：路由權限（頁面訪問權限）和功能權限（操作權限）
- **FR-003**: 每個權限必須包含唯一的權限代碼、名稱、描述和類型（路由或功能）
- **FR-004**: 路由權限必須與前端路由路徑（如「/inventory」）關聯
- **FR-005**: 功能權限必須使用命名規範（如「resource.action」格式，例如「inventory.create」）
- **FR-006**: 系統必須提供角色管理介面，允許管理員新增、修改、刪除和查詢角色
- **FR-007**: 每個角色必須包含唯一的角色名稱和描述
- **FR-008**: 系統必須允許管理員為角色分配多個權限（包括路由權限和功能權限）
- **FR-009**: 系統必須允許管理員從角色中移除已分配的權限
- **FR-010**: 系統必須提供介面讓管理員查看角色的所有已分配權限
- **FR-011**: 系統必須支援為用戶指派一個或多個角色
- **FR-012**: 系統必須支援從用戶移除已指派的角色
- **FR-013**: 系統必須在用戶嘗試訪問頁面時驗證該用戶是否擁有對應的路由權限
- **FR-014**: 系統必須在用戶嘗試執行操作時驗證該用戶是否擁有對應的功能權限
- **FR-015**: 當用戶擁有多個角色時，系統必須合併所有角色的權限（聯集），用戶擁有任一角色的權限即可執行相應操作
- **FR-016**: 當用戶權限驗證失敗時，系統必須拒絕訪問並返回明確的錯誤訊息（如「無權限訪問此頁面」或「權限不足，無法執行此操作」）
- **FR-017**: 系統必須阻止刪除正被角色使用的權限，並提示管理員需要先從角色中移除該權限
- **FR-018**: 系統必須阻止刪除正被用戶使用的角色，並提示管理員需要先從用戶中移除該角色
- **FR-019**: 系統必須記錄所有權限管理相關操作的稽核日誌，包括權限的新增、修改、刪除
- **FR-020**: 系統必須記錄所有角色管理相關操作的稽核日誌，包括角色的新增、修改、刪除、權限分配
- **FR-021**: 系統必須記錄所有用戶角色指派相關操作的稽核日誌
- **FR-022**: 每條稽核日誌必須包含以下欄位：操作者ID、操作者名稱、操作時間、操作類型、目標對象（如權限ID、角色ID、用戶ID）、變更前狀態、變更後狀態、操作者IP位址、操作者UserAgent
- **FR-023**: 系統必須提供稽核日誌查詢介面，支援按操作者、操作時間範圍、操作類型篩選日誌
- **FR-024**: 稽核日誌必須持久化儲存，且不可被修改或刪除（僅可新增和查詢），永久保留以符合合規要求
- **FR-025**: 系統必須在用戶會話期間使用最新的權限配置進行驗證（而非登入時的快照），權限變更必須在下次請求時即時生效
- **FR-026**: 系統必須提供介面讓管理員查看用戶的有效權限（所有角色權限的合併結果）
- **FR-027**: 系統必須驗證權限代碼的唯一性，拒絕創建重複的權限代碼
- **FR-028**: 系統必須驗證角色名稱的唯一性，拒絕創建重複的角色名稱
- **FR-029**: 當稽核日誌寫入失敗時，系統必須回滾相應的權限管理操作
- **FR-030**: 系統必須確保權限驗證邏輯的執行緒安全，支援併發請求
- **FR-031**: 系統必須記錄所有權限驗證失敗的嘗試，包含用戶ID、嘗試訪問的資源、失敗原因、時間戳、IP位址

### Key Entities

- **權限 (Permission)**：系統中定義的訪問或操作授權。包含權限代碼（唯一標識）、名稱、描述、類型（路由權限或功能權限）、關聯路徑（對於路由權限）。路由權限控制頁面訪問，功能權限控制具體操作（如新增、修改、刪除）。
  
- **角色 (Role)**：權限的集合，用於簡化用戶權限管理。包含角色ID、角色名稱（唯一）、描述、創建時間、更新時間。一個角色可以擁有多個權限，一個權限可以被多個角色使用（多對多關係）。

- **用戶角色關聯 (UserRole)**：連接用戶與角色的關係。記錄用戶ID、角色ID、指派時間、指派者ID。一個用戶可以擁有多個角色，一個角色可以被多個用戶使用（多對多關係）。

- **角色權限關聯 (RolePermission)**：連接角色與權限的關係。記錄角色ID、權限ID、分配時間、分配者ID。一個角色可以擁有多個權限，一個權限可以被多個角色使用（多對多關係）。

- **稽核日誌 (AuditLog)**：記錄權限管理相關操作的歷史記錄。包含日誌ID、操作者ID、操作者名稱、操作時間、操作類型（如「新增權限」、「修改角色」、「指派角色」）、目標對象類型（如「權限」、「角色」、「用戶」）、目標對象ID、變更前狀態（JSON格式）、變更後狀態（JSON格式）、操作者IP位址、操作者UserAgent。日誌為只讀，不可修改或刪除，永久保留。

- **權限驗證失敗記錄 (PermissionFailureLog)**：記錄所有權限驗證失敗的嘗試。包含記錄ID、用戶ID、用戶名稱、嘗試訪問的資源（路由或功能權限代碼）、失敗原因、嘗試時間、IP位址、UserAgent。用於安全監控和問題排查。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 管理員可以在2分鐘內完成一個新權限的創建和配置
- **SC-002**: 管理員可以在3分鐘內完成一個新角色的創建及權限分配
- **SC-003**: 系統在單次請求中可以在100毫秒內完成權限驗證（包括多角色權限合併）
- **SC-004**: 系統支援至少1000個用戶同時進行權限驗證請求，且回應時間不超過200毫秒
- **SC-005**: 所有權限管理相關操作必須100%記錄在稽核日誌中，無遺漏
- **SC-006**: 管理員可以在1分鐘內查詢並找到特定用戶在特定時間範圍內的所有操作記錄
- **SC-007**: 當用戶權限變更後，系統在下次權限驗證時必須使用最新配置，即時生效無延遲
- **SC-008**: 系統在高併發情況下（1000 TPS）權限驗證的準確率必須達到100%
- **SC-009**: 管理員可以在30秒內查看任一用戶的有效權限列表（包括多角色權限合併結果）
- **SC-010**: 稽核日誌查詢介面支援至少100萬條日誌記錄的快速篩選和分頁顯示
- **SC-011**: 權限驗證失敗記錄可供管理員查詢，支援按用戶、時間範圍、資源類型篩選，查詢回應時間不超過2秒
