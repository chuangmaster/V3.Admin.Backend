# Implementation Plan: Account Module Refactoring

**Branch**: `007-account-refactor` | **Date**: 2026-01-20 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/007-account-refactor/spec.md`

**Note**: This template is filled in by the `/speckit.plan` command. See `.specify/templates/commands/plan.md` for the execution workflow.

## Summary

重構 User 模組以提高模組識別性,將 username 欄位重命名為 account,並將密碼修改功能分離成兩個獨立的 API:用戶自助密碼修改和管理員密碼重設。同時補足完整的 Account 模組權限控制(account.read, account.update, account.delete)。

**技術方法**:
- 資料庫遷移:使用 SQL migration script 重命名 username 欄位為 account
- API 層重構:更新所有 Controllers, Services, Repositories 使用新欄位名稱
- 密碼 API 分離:建立 `PUT /api/account/me/password` (用戶自助) 和 `PUT /api/account/{id}/reset-password` (管理員重設)
- 併發控制:使用資料庫 WHERE version=X 條件確保樂觀鎖定
- 會話管理:使用既有 version 欄位進行 token 驗證,任何資料修改都會使 token 失效
- 權限補充:新增 account.read, account.update, account.delete 權限並配置到相關端點

## Technical Context

**Language/Version**: C# 13 / .NET 10.0  
**Primary Framework**: ASP.NET Core 10.0 (Web API)  
**Database**: PostgreSQL 15+  
**ORM**: Dapper (Micro-ORM)  
**Authentication**: JWT Bearer Token (Microsoft.AspNetCore.Authentication.JwtBearer)  
**Password Hashing**: BCrypt.Net-Next (work factor 12)  
**Input Validation**: FluentValidation  
**API Documentation**: Swagger/OpenAPI 3.0 (Swashbuckle.AspNetCore)  
**Logging**: Serilog / Microsoft.Extensions.Logging  
**Testing**: xUnit, Moq, FluentAssertions, Testcontainers  
**Target Platform**: Linux/Windows Server (Dockerized)  
**Project Type**: ASP.NET Core Web API (Single Project Architecture)  
**Architecture Pattern**: Three-layer architecture (Controller → Service → Repository)  
**Performance Goals**: 
- API response time < 200ms (p95)
- Support 1000+ concurrent requests
- Database query optimization (proper indexing, avoid N+1 queries)

**Constraints**: 
- All API responses must use unified format (ApiResponseModel<T>)
- All exceptions must be handled by ExceptionHandlingMiddleware
- All requests must include TraceId (generated by TraceIdMiddleware)
- Sensitive data (passwords, tokens) must not be logged
- Database fields use snake_case, C# properties use PascalCase

**Scale/Scope**: 
- Expected users: 1,000 - 10,000
- Data volume: Millions of records (consider pagination and indexing strategies)
- API endpoints: 30-50 endpoints (covering accounts, permissions, roles, audits)

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

Verify whether this feature complies with the five core principles of the [Project Constitution](../../.specify/memory/constitution.md):

### ✅ Principle 1: Simplicity First
- [x] Adopt three-layer architecture (Controller → Service → Repository)
- [x] Avoid unnecessary abstraction layers or design patterns
- [x] Prioritize using .NET built-in features
- [x] Document clear reasons if introducing new patterns

**說明**: 此功能僅涉及既有三層架構的更新,無需引入新的抽象層。資料庫遷移使用標準 SQL 腳本,API 層使用 Dapper 執行簡單的 UPDATE 語句配合 WHERE version=X 條件。

### ✅ Principle 2: Test-Driven Quality
- [x] Critical paths have unit test coverage
- [x] API endpoints have integration tests (using Testcontainers)
- [x] Tests written before implementation (TDD)
- [x] Validators achieve 100% test coverage

**說明**: 需要為以下內容編寫測試:
- AccountService.ChangePasswordAsync 和 ResetPasswordAsync 的單元測試(包含各種失敗場景)
- ChangePasswordRequestValidator 和 ResetPasswordRequestValidator 的完整覆蓋測試
- 使用 Testcontainers 測試併發控制(version 衝突)和審計日誌記錄
- 測試權限驗證(account.update, user.profile.update)

### ✅ Principle 3: Security Non-Negotiable
- [x] API endpoints use JWT Bearer Token authentication (except login)
- [x] Passwords use BCrypt hashing (work factor 12)
- [x] Database queries use parameterized queries (Dapper parameters)
- [x] Input validation uses FluentValidation
- [x] Delete operations use soft delete
- [x] Concurrent updates use optimistic locking (version field)
- [x] Sensitive settings use environment variables or Azure Key Vault

**說明**: 
- FR-007a 和 FR-013a 明確要求使用 WHERE version=X 條件實現樂觀鎖定
- FR-008 和 FR-012 要求權限驗證(user.profile.update 和 account.update)
- FR-014 要求記錄審計日誌
- 密碼仍使用 BCrypt 加密,JWT 認證機制不變
- 注意:密碼不得出現在日誌中,僅記錄操作類型和用戶 ID

### ✅ Principle 4: Observability First
- [x] HTTP requests include TraceId
- [x] Exceptions log full stack traces
- [x] Critical operations write to audit logs (audit_logs table)
- [x] Use structured logging (Serilog / ILogger)
- [x] API responses include unified format (ApiResponseModel<T>)

**說明**:
- FR-014 要求密碼重設操作必須記錄到審計日誌
- 密碼修改和重設操作的成功/失敗都應該記錄結構化日誌(不含密碼內容)
- 併發衝突錯誤應該記錄 user ID, trace ID, 和嘗試使用的 version
- TraceId 由現有 TraceIdMiddleware 自動處理

### ✅ Principle 5: Documentation as Code
- [x] Public APIs have XML documentation comments
- [x] Features have complete documentation (spec.md, plan.md, quickstart.md)
- [x] User stories have priority sorting (P1, P2, P3...)
- [x] API contract documentation synchronized (api-spec.yaml)
- [x] All user-facing documentation in Traditional Chinese
- [x] Code comments in Traditional Chinese

**說明**:
- 新增的兩個端點(PUT /api/account/me/password 和 PUT /api/account/{id}/reset-password)需要完整的 XML 註解
- 需要更新 OpenAPI spec 加入新端點定義
- 資料庫遷移腳本需要註解說明為何重命名欄位
- Controller、Service、Repository 的公開方法需要中文 XML 註解

**Constitution Check Result**: **PASS**

**Conditional or Violation Explanation**: 無條件通過或違規項目。此功能完全符合專案憲法的所有五項核心原則。

## Project Structure

### Documentation (this feature)

```text
specs/[###-feature]/
├── plan.md              # This file (/speckit.plan command output)
├── research.md          # Phase 0 output (/speckit.plan command)
├── data-model.md        # Phase 1 output (/speckit.plan command)
├── quickstart.md        # Phase 1 output (/speckit.plan command)
├── contracts/           # Phase 1 output (/speckit.plan command)
└── tasks.md             # Phase 2 output (/speckit.tasks command - NOT created by /speckit.plan)
```

### Source Code (V3.Admin.Backend Project Structure)

**Project Type**: ASP.NET Core Web API (Single Project Architecture)

```text
V3.Admin.Backend/                    # Project root directory
├── Controllers/                     # API controllers (Presentation layer)
│   ├── AuthController.cs           # Authentication endpoints
│   ├── AccountController.cs        # Account management endpoints
│   ├── PermissionController.cs     # Permission management endpoints
│   ├── RoleController.cs           # Role management endpoints
│   ├── UserRoleController.cs       # User role endpoints
│   ├── AuditLogController.cs       # Audit log endpoints
│   └── BaseApiController.cs        # Base controller
│
├── Services/                        # Business logic layer
│   ├── Interfaces/                 # Service interfaces
│   │   ├── IAuthService.cs
│   │   ├── IAccountService.cs
│   │   ├── IPermissionService.cs
│   │   └── ...
│   ├── AuthService.cs
│   ├── AccountService.cs
│   ├── PermissionService.cs
│   ├── JwtService.cs
│   └── ...
│
├── Repositories/                    # Data access layer
│   ├── Interfaces/                 # Repository interfaces
│   │   ├── IUserRepository.cs
│   │   ├── IPermissionRepository.cs
│   │   └── ...
│   ├── UserRepository.cs
│   ├── PermissionRepository.cs
│   ├── RoleRepository.cs
│   └── ...
│
├── Models/                          # Data models
│   ├── Entities/                   # Database entities (snake_case mapping)
│   │   ├── User.cs
│   │   ├── Permission.cs
│   │   └── ...
│   ├── Dtos/                       # Data transfer objects
│   │   ├── UserDto.cs
│   │   ├── PermissionDto.cs
│   │   └── ...
│   ├── Requests/                   # API request models
│   │   ├── LoginRequest.cs
│   │   ├── CreateAccountRequest.cs
│   │   └── ...
│   ├── Responses/                  # API response models
│   │   ├── LoginResponse.cs
│   │   ├── AccountResponse.cs
│   │   └── ...
│   ├── ApiResponseModel.cs         # Unified response wrapper
│   └── ResponseCodes.cs            # Response code definitions
│
├── Validators/                      # FluentValidation validators
│   ├── LoginRequestValidator.cs
│   ├── CreateAccountRequestValidator.cs
│   └── ...
│
├── Middleware/                      # ASP.NET Core middleware
│   ├── ExceptionHandlingMiddleware.cs
│   ├── TraceIdMiddleware.cs
│   └── PermissionAuthorizationMiddleware.cs
│
├── Configuration/                   # Configuration models
│   ├── DatabaseSettings.cs
│   ├── JwtSettings.cs
│   └── ...
│
├── Database/                        # Database scripts
│   ├── Migrations/                 # Migration scripts (executed in order)
│   │   ├── 001_CreateUsersTable.sql
│   │   ├── 002_CreatePermissionsTable.sql
│   │   └── ...
│   └── Scripts/                    # Seed data and helper scripts
│       └── seed.sql
│
├── Tests/                           # Test project
│   ├── Unit/                       # Unit tests
│   │   ├── Validators/             # Validator tests
│   │   └── Services/               # Service tests
│   ├── Integration/                # Integration tests (using Testcontainers)
│   │   └── Controllers/            # API endpoint tests
│   └── Helpers/                    # Test helper utilities
│
├── specs/                           # Feature specification documents (Traditional Chinese)
│   └── [###-feature-name]/
│       ├── spec.md
│       ├── plan.md
│       ├── quickstart.md
│       ├── data-model.md
│       ├── tasks.md
│       └── contracts/
│           └── api-spec.yaml
│
├── .specify/                        # Speckit configuration
│   ├── memory/
│   │   ├── constitution.md         # Project constitution
│   │   └── technical-reference.md  # Technical reference
│   └── templates/
│
├── Program.cs                       # Application entry point
├── appsettings.json                # Application settings
├── appsettings.Development.json    # Development environment settings
├── Dockerfile                       # Docker containerization
└── V3.Admin.Backend.csproj         # Project file
```

**Architecture Notes**:
- **Three-layer architecture**: Controller → Service → Repository
- **DTO pattern**: API and business logic layers use DTOs, data layer uses Entities
- **Interface segregation**: Services and Repositories both have corresponding Interfaces folders
- **Dependency injection**: All services and Repositories registered in Program.cs

## Complexity Tracking

> **Fill ONLY if Constitution Check has violations that must be justified**

**無違規項目** - 此功能完全符合專案憲法所有原則,無需記錄任何複雜度例外。

---

## Phase 0: Research ✅

**Status**: Completed  
**Output**: [research.md](research.md)

已完成以下技術研究:
1. ✅ 資料庫欄位重命名最佳實踐 → 使用 ALTER TABLE RENAME COLUMN with transaction
2. ✅ JWT 會話失效機制 → 使用既有 version 欄位進行 token 驗證
3. ✅ Dapper 併發控制實作 → WHERE version=X + RETURNING clause
4. ✅ 審計日誌設計確認 → 使用現有 audit_logs 表

**Architecture Decisions**:
- **AD-001**: 使用單一 version 欄位同時處理併發控制和 token 驗證(符合 Simplicity First)
- **AD-002**: 直接重命名欄位,不提供向後相容性(符合 clarification 決策)
- **AD-003**: 使用 RETURNING 子句驗證更新成功(PostgreSQL 原生支援)

---

## Phase 1: Design & Contracts ✅

**Status**: Completed  
**Outputs**: 
- [data-model.md](data-model.md) - 資料模型定義
- [contracts/api-spec.yaml](contracts/api-spec.yaml) - OpenAPI 3.0 規格
- [quickstart.md](quickstart.md) - 開發者實作指南

### Data Model Changes

**User Entity**:
- ✅ 欄位重命名:`username` → `account`
- ✅ 使用既有 `version` 欄位進行併發控制和 token 驗證
- ✅ Migration scripts 已定義:
  - `006_RenameUsernameToAccount.sql`

**AuditLog Entity**:
- ✅ 無結構變更,使用現有欄位記錄密碼重設操作

### API Contracts

**新增端點**:
1. ✅ `PUT /api/account/me/password` - 用戶自助密碼修改
   - 權限:`user.profile.update`
   - 請求:oldPassword, newPassword, version
   - 併發控制:樂觀鎖定
   - 會話管理:保留當前會話,失效其他會話

2. ✅ `PUT /api/account/{id}/reset-password` - 管理員密碼重設
   - 權限:`account.update`
   - 請求:newPassword, version(無需 oldPassword)
   - 審計日誌:記錄操作者和目標用戶
   - 通知:無自動通知

### Implementation Guidance

[quickstart.md](quickstart.md) 提供完整開發指南,包含:
- ✅ 7 個開發階段的詳細步驟
- ✅ 程式碼範例(Repository, Service, Controller, Validators)
- ✅ 測試撰寫指南(單元測試、整合測試)
- ✅ Checklist 驗證清單
- ✅ Troubleshooting 常見問題

**預估開發時間**: 2-3 個工作日

---

## Implementation Summary

此 Account Module Refactoring 功能已完成所有規劃階段:

### ✅ Specification Phase
- Feature specification with 4 user stories (P1-P3 prioritized)
- 22 functional requirements (FR-001 to FR-022)
- 8 measurable success criteria
- 5 clarifications resolved

### ✅ Constitution Compliance
- **Simplicity First**: 三層架構,無額外抽象層
- **Test-Driven Quality**: 完整測試策略定義
- **Security Non-Negotiable**: 樂觀鎖定、權限驗證、審計日誌
- **Observability First**: TraceId、結構化日誌、審計記錄
- **Documentation as Code**: XML 註解、API 規格、中文文件

### ✅ Research Complete
- 4 technical unknowns resolved
- 3 architecture decisions documented
- Token version mechanism designed
- Database migration strategy defined

### ✅ Design Artifacts
- Data model with 2 migrations
- OpenAPI 3.0 specification
- Request/Response models
- Validation rules

### ✅ Developer Ready
- Step-by-step quickstart guide
- Code examples for all layers
- Testing strategy with examples
- Troubleshooting guide

---

## Next Steps

**This Phase (planning) is now COMPLETE**. To proceed with implementation:

1. **Start Development**: Follow [quickstart.md](quickstart.md) implementation roadmap
2. **Task Decomposition** (Optional): Run `/speckit.tasks` to break down into detailed work items
3. **Begin Coding**: Start with Phase 1 (Database Migrations) in quickstart guide

**Recommended Workflow**:
```bash
# 1. Ensure you're on the correct branch
git checkout 007-account-refactor

# 2. Execute database migrations
psql -f Database/Migrations/006_RenameUsernameToAccount.sql

# 3. Follow quickstart.md Phase 2-7 for code implementation

# 4. Write tests as you develop (TDD approach)
dotnet test

# 5. Commit progress regularly
git add .
git commit -m "feat: implement password change API"
```

---

**Plan Generated**: 2026-01-20  
**Constitution Check**: PASS  
**Ready for Implementation**: YES ✅

