# Implementation Plan: [FEATURE]

**Branch**: `[###-feature-name]` | **Date**: [DATE] | **Spec**: [link]
**Input**: Feature specification from `/specs/[###-feature-name]/spec.md`

**Note**: This template is filled in by the `/speckit.plan` command. See `.specify/templates/commands/plan.md` for the execution workflow.

## Summary

[Extract from feature spec: primary requirement + technical approach from research]

## Technical Context

**Language/Version**: C# 13 / .NET 10.0  
**Primary Framework**: ASP.NET Core 10.0 (Web API)  
**Database**: PostgreSQL 15+  
**ORM**: Dapper (Micro-ORM)  
**Authentication**: JWT Bearer Token (Microsoft.AspNetCore.Authentication.JwtBearer)  
**Password Hashing**: BCrypt.Net-Next (work factor 12)  
**Input Validation**: FluentValidation  
**API Documentation**: Swagger/OpenAPI 3.0 (Swashbuckle.AspNetCore)  
**Logging**: Serilog / Microsoft.Extensions.Logging  
**Testing**: xUnit, Moq, FluentAssertions, Testcontainers  
**Target Platform**: Linux/Windows Server (Dockerized)  
**Project Type**: ASP.NET Core Web API (Single Project Architecture)  
**Architecture Pattern**: Three-layer architecture (Controller → Service → Repository)  
**Performance Goals**: 
- API response time < 200ms (p95)
- Support 1000+ concurrent requests
- Database query optimization (proper indexing, avoid N+1 queries)

**Constraints**: 
- All API responses must use unified format (ApiResponseModel<T>)
- All exceptions must be handled by ExceptionHandlingMiddleware
- All requests must include TraceId (generated by TraceIdMiddleware)
- Sensitive data (passwords, tokens) must not be logged
- Database fields use snake_case, C# properties use PascalCase

**Scale/Scope**: 
- Expected users: 1,000 - 10,000
- Data volume: Millions of records (consider pagination and indexing strategies)
- API endpoints: 30-50 endpoints (covering accounts, permissions, roles, audits)

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

Verify whether this feature complies with the five core principles of the [Project Constitution](./../memory/constitution.md):

### ✅ Principle 1: Simplicity First
- [ ] Adopt three-layer architecture (Controller → Service → Repository)
- [ ] Avoid unnecessary abstraction layers or design patterns
- [ ] Prioritize using .NET built-in features
- [ ] Document clear reasons if introducing new patterns

### ✅ Principle 2: Test-Driven Quality
- [ ] Critical paths have unit test coverage
- [ ] API endpoints have integration tests (using Testcontainers)
- [ ] Tests written before implementation (TDD)
- [ ] Validators achieve 100% test coverage

### ✅ Principle 3: Security Non-Negotiable
- [ ] API endpoints use JWT Bearer Token authentication (except login)
- [ ] Passwords use BCrypt hashing (work factor 12)
- [ ] Database queries use parameterized queries (Dapper parameters)
- [ ] Input validation uses FluentValidation
- [ ] Delete operations use soft delete
- [ ] Concurrent updates use optimistic locking (version field)
- [ ] Sensitive settings use environment variables or Azure Key Vault

### ✅ Principle 4: Observability First
- [ ] HTTP requests include TraceId
- [ ] Exceptions log full stack traces
- [ ] Critical operations write to audit logs (audit_logs table)
- [ ] Use structured logging (Serilog / ILogger)
- [ ] API responses include unified format (ApiResponseModel<T>)

### ✅ Principle 5: Documentation as Code
- [ ] Public APIs have XML documentation comments
- [ ] Features have complete documentation (spec.md, plan.md, quickstart.md)
- [ ] User stories have priority sorting (P1, P2, P3...)
- [ ] API contract documentation synchronized (api-spec.yaml)
- [ ] All user-facing documentation in Traditional Chinese
- [ ] Code comments in Traditional Chinese

**Constitution Check Result**: [PASS / CONDITIONAL / FAIL]

**Conditional or Violation Explanation**: [If conditionally passed or violated, explain reasons and alternative solution evaluation in detail]

## Project Structure

### Documentation (this feature)

```text
specs/[###-feature]/
├── plan.md              # This file (/speckit.plan command output)
├── research.md          # Phase 0 output (/speckit.plan command)
├── data-model.md        # Phase 1 output (/speckit.plan command)
├── quickstart.md        # Phase 1 output (/speckit.plan command)
├── contracts/           # Phase 1 output (/speckit.plan command)
└── tasks.md             # Phase 2 output (/speckit.tasks command - NOT created by /speckit.plan)
```

### Source Code (V3.Admin.Backend Project Structure)

**Project Type**: ASP.NET Core Web API (Single Project Architecture)

```text
V3.Admin.Backend/                    # Project root directory
├── Controllers/                     # API controllers (Presentation layer)
│   ├── AuthController.cs           # Authentication endpoints
│   ├── AccountController.cs        # Account management endpoints
│   ├── PermissionController.cs     # Permission management endpoints
│   ├── RoleController.cs           # Role management endpoints
│   ├── UserRoleController.cs       # User role endpoints
│   ├── AuditLogController.cs       # Audit log endpoints
│   └── BaseApiController.cs        # Base controller
│
├── Services/                        # Business logic layer
│   ├── Interfaces/                 # Service interfaces
│   │   ├── IAuthService.cs
│   │   ├── IAccountService.cs
│   │   ├── IPermissionService.cs
│   │   └── ...
│   ├── AuthService.cs
│   ├── AccountService.cs
│   ├── PermissionService.cs
│   ├── JwtService.cs
│   └── ...
│
├── Repositories/                    # Data access layer
│   ├── Interfaces/                 # Repository interfaces
│   │   ├── IUserRepository.cs
│   │   ├── IPermissionRepository.cs
│   │   └── ...
│   ├── UserRepository.cs
│   ├── PermissionRepository.cs
│   ├── RoleRepository.cs
│   └── ...
│
├── Models/                          # Data models
│   ├── Entities/                   # Database entities (snake_case mapping)
│   │   ├── User.cs
│   │   ├── Permission.cs
│   │   └── ...
│   ├── Dtos/                       # Data transfer objects
│   │   ├── UserDto.cs
│   │   ├── PermissionDto.cs
│   │   └── ...
│   ├── Requests/                   # API request models
│   │   ├── LoginRequest.cs
│   │   ├── CreateAccountRequest.cs
│   │   └── ...
│   ├── Responses/                  # API response models
│   │   ├── LoginResponse.cs
│   │   ├── AccountResponse.cs
│   │   └── ...
│   ├── ApiResponseModel.cs         # Unified response wrapper
│   └── ResponseCodes.cs            # Response code definitions
│
├── Validators/                      # FluentValidation validators
│   ├── LoginRequestValidator.cs
│   ├── CreateAccountRequestValidator.cs
│   └── ...
│
├── Middleware/                      # ASP.NET Core middleware
│   ├── ExceptionHandlingMiddleware.cs
│   ├── TraceIdMiddleware.cs
│   └── PermissionAuthorizationMiddleware.cs
│
├── Configuration/                   # Configuration models
│   ├── DatabaseSettings.cs
│   ├── JwtSettings.cs
│   └── ...
│
├── Database/                        # Database scripts
│   ├── Migrations/                 # Migration scripts (executed in order)
│   │   ├── 001_CreateUsersTable.sql
│   │   ├── 002_CreatePermissionsTable.sql
│   │   └── ...
│   └── Scripts/                    # Seed data and helper scripts
│       └── seed.sql
│
├── Tests/                           # Test project
│   ├── Unit/                       # Unit tests
│   │   ├── Validators/             # Validator tests
│   │   └── Services/               # Service tests
│   ├── Integration/                # Integration tests (using Testcontainers)
│   │   └── Controllers/            # API endpoint tests
│   └── Helpers/                    # Test helper utilities
│
├── specs/                           # Feature specification documents (Traditional Chinese)
│   └── [###-feature-name]/
│       ├── spec.md
│       ├── plan.md
│       ├── quickstart.md
│       ├── data-model.md
│       ├── tasks.md
│       └── contracts/
│           └── api-spec.yaml
│
├── .specify/                        # Speckit configuration
│   ├── memory/
│   │   ├── constitution.md         # Project constitution
│   │   └── technical-reference.md  # Technical reference
│   └── templates/
│
├── Program.cs                       # Application entry point
├── appsettings.json                # Application settings
├── appsettings.Development.json    # Development environment settings
├── Dockerfile                       # Docker containerization
└── V3.Admin.Backend.csproj         # Project file
```

**Architecture Notes**:
- **Three-layer architecture**: Controller → Service → Repository
- **DTO pattern**: API and business logic layers use DTOs, data layer uses Entities
- **Interface segregation**: Services and Repositories both have corresponding Interfaces folders
- **Dependency injection**: All services and Repositories registered in Program.cs

## Complexity Tracking

> **Fill ONLY if Constitution Check has violations that must be justified**

| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|-------------------------------------|
| [e.g., 4th project] | [current need] | [why 3 projects insufficient] |
| [e.g., Repository pattern] | [specific problem] | [why direct DB access insufficient] |
